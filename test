cat <<'EOF' > setup_cypherium.sh
#!/bin/bash
set -euo pipefail

# ==================================================
# Root check
# ==================================================
if [ "$(id -u)" -ne 0 ]; then
  echo "ERROR: This script must be run as root"
  echo "Example:"
  echo "  sudo bash setup_cypherium.sh"
  exit 1
fi

export DEBIAN_FRONTEND=noninteractive

# ==================================================
# Base packages & firewall (+ Node via n stable + pm2)
# ==================================================
apt update

apt install -y --no-install-recommends \
  ca-certificates curl wget git nano rsync ufw \
  build-essential gcc cmake m4 bzip2 texinfo pkg-config \
  libssl-dev openssl libgmp-dev libc-dev \
  python3 python3-venv python3-pip python3-dev \
  nodejs npm pcscd

# Node.js: switch to latest stable via n, then remove apt node/npm
npm install -g n
n stable
apt purge -y nodejs npm
apt autoremove -y
export PATH="/usr/local/bin:$PATH"
grep -q '^export PATH=/usr/local/bin:\$PATH' /root/.bashrc || echo 'export PATH=/usr/local/bin:$PATH' >> /root/.bashrc
hash -r
npm install -g pm2

ufw allow 22/tcp
ufw allow 8000/tcp
ufw allow 6000/tcp
ufw allow 6000/udp
ufw allow 7100/tcp
ufw allow 7100/udp
ufw allow 7002/tcp
ufw allow 7002/udp
ufw allow 30303/tcp
ufw allow 30303/udp
ufw allow 30301/tcp
ufw allow 30301/udp
ufw allow 8546/tcp
ufw allow 9090/tcp
ufw allow 9090/udp
ufw allow 9600/tcp
ufw allow 9600/udp
ufw --force enable
ufw status numbered || true

# ==================================================
# Step 1: Update system
# ==================================================
echo "ðŸ§© Step 1: Update and clean packages"
apt update
apt full-upgrade -y
apt autoremove -y
apt autoclean -y

# ==================================================
# Step 2: Go
# ==================================================
echo "ðŸ§© Step 2: Install Go 1.25.6"
GO_VER="1.25.6"
GO_TGZ="go${GO_VER}.linux-amd64.tar.gz"
wget -4 -O "/tmp/${GO_TGZ}" "https://go.dev/dl/${GO_TGZ}"
rm -rf /usr/local/go
tar -C /usr/local -xzf "/tmp/${GO_TGZ}"
rm -f "/tmp/${GO_TGZ}"

# ==================================================
# Step 3: Go env
# ==================================================
echo "ðŸ§© Step 3: Configure Go environment variables"
export PATH=/usr/local/go/bin:$PATH
export GOPATH=/root/go
export GO111MODULE=off
go env -w GO111MODULE=off

grep -q '/usr/local/go/bin' /root/.bashrc || echo 'export PATH=/usr/local/go/bin:$PATH' >> /root/.bashrc
grep -q '^export GOPATH=' /root/.bashrc || echo 'export GOPATH=/root/go' >> /root/.bashrc
grep -q '^export GO111MODULE=' /root/.bashrc || echo 'export GO111MODULE=off' >> /root/.bashrc
mkdir -p "$GOPATH/src"

# ==================================================
# Step 5: Prefer IPv4 (optional)
# ==================================================
if [ -f /etc/gai.conf ]; then
  sed -i 's/^[#[:space:]]*precedence ::ffff:0:0\/96[[:space:]]\+100/precedence ::ffff:0:0\/96  100/' /etc/gai.conf || true
fi

# ==================================================
# Step 6: Cypherium source
# ==================================================
echo "ðŸ§© Step 6: Clone Cypherium source code and copy BLS libraries"
mkdir -p "$GOPATH/src/github.com/cypherium"
cd "$GOPATH/src/github.com/cypherium"

if [ ! -d cypher/.git ]; then
  git clone https://github.com/cypherium/cypher.git
fi

cd cypher
git fetch --all
git checkout ecdsa_1.1

if ls ./crypto/bls/lib/linux/* >/dev/null 2>&1; then
  cp -f ./crypto/bls/lib/linux/* ./crypto/bls/lib/
fi

# ==================================================
# Step 7: External Go packages
# ==================================================
echo "ðŸ§© Step 7: Clone external Go packages"

mkdir -p "$GOPATH/src/github.com/VictoriaMetrics"
cd "$GOPATH/src/github.com/VictoriaMetrics"
[ -d fastcache/.git ] || git clone https://github.com/VictoriaMetrics/fastcache.git

mkdir -p "$GOPATH/src/github.com/shirou"
cd "$GOPATH/src/github.com/shirou"
[ -d gopsutil/.git ] || git clone https://github.com/shirou/gopsutil.git

mkdir -p "$GOPATH/src/github.com/dlclark"
cd "$GOPATH/src/github.com/dlclark"
[ -d regexp2/.git ] || git clone https://github.com/dlclark/regexp2.git

mkdir -p "$GOPATH/src/github.com/go-sourcemap"
cd "$GOPATH/src/github.com/go-sourcemap"
[ -d sourcemap/.git ] || git clone https://github.com/go-sourcemap/sourcemap.git

mkdir -p "$GOPATH/src/github.com/tklauser"
cd "$GOPATH/src/github.com/tklauser"
[ -d go-sysconf/.git ] || git clone https://github.com/tklauser/go-sysconf.git
[ -d numcpus/.git ] || git clone https://github.com/tklauser/numcpus.git

mkdir -p "$GOPATH/src/golang.org/x"
cd "$GOPATH/src/golang.org/x"
[ -d sys/.git ] || git clone https://go.googlesource.com/sys

# ==================================================
# Step 8: Patch duk_logging.c (avoid ",," error)
# ==================================================
echo "ðŸ§© Step 8: Patch duk_logging.c"
DUK_LOGGING_PATH="$GOPATH/src/github.com/cypherium/cypher/vendor/gopkg.in/olebedev/go-duktape.v3/duk_logging.c"
if [ -f "$DUK_LOGGING_PATH" ]; then
  sed -i 's/duk_uint8_t date_buf\[32\]/duk_uint8_t date_buf[64]/' "$DUK_LOGGING_PATH" || true
  sed -i 's/sprintf((char \*) date_buf,/snprintf((char *) date_buf, sizeof(date_buf),/g' "$DUK_LOGGING_PATH" || true
fi

# ==================================================
# Step 9: Build Cypher (safe patch)
# ==================================================
echo "ðŸ§© Step 9: Build Cypher"
cd "$GOPATH/src/github.com/cypherium/cypher"

git checkout -- vendor/github.com/fjl/memsize/memsize.go \
               vendor/gopkg.in/olebedev/go-duktape.v3/duk_logging.c 2>/dev/null || true

# re-apply duk patch after revert
if [ -f "$DUK_LOGGING_PATH" ]; then
  sed -i 's/duk_uint8_t date_buf\[32\]/duk_uint8_t date_buf[64]/' "$DUK_LOGGING_PATH" || true
  sed -i 's/sprintf((char \*) date_buf,/snprintf((char *) date_buf, sizeof(date_buf),/g' "$DUK_LOGGING_PATH" || true
fi

MEMSIZE_PATH="vendor/github.com/fjl/memsize/memsize.go"
if [ -f "$MEMSIZE_PATH" ]; then
  perl -0777 -i -pe '
    my @l = split(/\n/,$_);
    for (@l) {
      if (/stopTheWorld\(/ && !/func\s+stopTheWorld/ && !/go:linkname/) { s/^(\s*)/$1\/\/ /; }
      if (/startTheWorld\(/ && !/func\s+startTheWorld/ && !/go:linkname/) { s/^(\s*)/$1\/\/ /; }
    }
    $_ = join("\n",@l);
  ' "$MEMSIZE_PATH"
fi

make clean
make cypher

# ==================================================
# Step 10: Genesis & chaindata
# ==================================================
echo "ðŸ§© Step 10: Initialize Genesis and load chaindata"
if [ ! -f ./genesis.json ]; then
  echo "ERROR: genesis.json not found in $PWD"
  exit 1
fi

./build/bin/cypher --datadir chaindbname init ./genesis.json

cd "$GOPATH/src/github.com/cypherium"
if [ ! -d cypher-bin/.git ]; then
  git clone https://github.com/cypherium/cypher-bin.git
fi

rm -rf "$GOPATH/src/github.com/cypherium/cypher/chaindbname/cypher/chaindata"
rsync -a cypher-bin/database/chaindb/cypher/chaindata/ cypher/chaindbname/cypher/chaindata/

# ==================================================
# Step 11: start-cypher.sh
# ==================================================
echo "ðŸ§© Step 11: Create start-cypher.sh script"
cd "$GOPATH/src/github.com/cypherium/cypher"

cat <<'EOT' > start-cypher.sh
#!/bin/bash
set -euo pipefail
EXTIP="$(curl -4 -s ifconfig.io || true)"
exec ./build/bin/cypher \
  --verbosity 4 \
  --rnetport 7100 \
  --syncmode full \
  ${EXTIP:+--nat extip:${EXTIP}} \
  --ws --ws.addr 0.0.0.0 --ws.port 8546 --ws.origins "*" \
  --rpc.gascap 10000000 --rpc.txfeecap 1000 \
  --http --http.addr 0.0.0.0 --http.port 8000 \
  --http.api eth,web3,net,txpool --http.corsdomain "*" \
  --port 6000 \
  --datadir chaindbname \
  --networkid 16166 \
  --gcmode archive \
  --bootnodes enode://a1e825dcb84155d5ec651a0cf98e22ac5d4dc34733d22eb6d031216ac2988646f0f85035118ec8e2369dace00221ed3a06a6aeacda520414e71f3b56662d7055@34.106.3.238:30301 \
  console
EOT
chmod +x start-cypher.sh

# ==================================================
# Step 12: PM2 launch
# ==================================================
echo "ðŸ§© Step 12: Launch with PM2"
pm2 start ./start-cypher.sh --name cypher-node
pm2 save

STARTUP_LINE="$(pm2 startup systemd -u root --hp /root | sed -n 's/^.*\(pm2 startup.*\)$/\1/p' | head -n 1 || true)"
if [ -n "$STARTUP_LINE" ]; then
  bash -lc "$STARTUP_LINE"
fi
pm2 save
# ==================================================
# Step 12.5: Mining setup (run while node is up)
# ==================================================
echo "ðŸ§© Step 12.5: Create & run mining-setup.sh (requires node IPC)"

cd /root

cat > mining-setup.sh <<'EOT'
#!/bin/bash
set -euo pipefail

GOPATH="${GOPATH:-$(go env GOPATH 2>/dev/null || true)}"
[[ -n "${GOPATH}" ]] || GOPATH="/root/go"

CY_DIR="$GOPATH/src/github.com/cypherium/cypher"
IPC="$CY_DIR/chaindbname/cypher.ipc"

[[ -d "$CY_DIR" ]] || { echo "[ERR] cypher dir not found: $CY_DIR"; exit 1; }

if [[ ! -S "$IPC" ]]; then
  echo "[ERR] IPC not found: $IPC"
  echo "      Node running? pm2 status"
  exit 1
fi

cd "$CY_DIR"

read -rsp "Set NEW account password: " PASS; echo
read -rp  "Etherbase address (blank = use new account): " EBASE

ADDR_RAW="$(./build/bin/cypher attach "ipc:${IPC}" --exec "personal.newAccountEd25519(\"${PASS}\")" 2>&1 || true)"
ADDR="$(printf "%s" "$ADDR_RAW" | sed -E 's/^"|"$//g' | tr -d '[:space:]')"

if [[ -z "$ADDR" ]] || [[ "$ADDR" == *"error"* ]] || [[ "$ADDR" == *"Error"* ]]; then
  echo "[ERR] Failed to create account."
  echo "$ADDR_RAW"
  exit 1
fi

echo "[OK] New account: $ADDR"

OUT_START="$(./build/bin/cypher attach "ipc:${IPC}" --exec "miner.start(1, \"${ADDR}\", \"${PASS}\")" 2>&1 || true)"
echo "[OK] miner.start issued"
echo "$OUT_START" | sed -E 's/^/[cypher] /'

[[ -n "$EBASE" ]] || EBASE="$ADDR"
OUT_EB="$(./build/bin/cypher attach "ipc:${IPC}" --exec "miner.setEtherbase(\"${EBASE}\")" 2>&1 || true)"
echo "[OK] miner.setEtherbase issued: $EBASE"
echo "$OUT_EB" | sed -E 's/^/[cypher] /'

echo
echo "Verify:"
echo "  ./build/bin/cypher attach ipc:${IPC}"
echo "  > eth.coinbase"
echo "  > miner.hashrate"
EOT

chmod +x /root/mining-setup.sh

# Wait for IPC (node may take a bit to create it)
GOPATH="${GOPATH:-/root/go}"
IPC="$GOPATH/src/github.com/cypherium/cypher/chaindbname/cypher.ipc"

echo "Waiting for IPC: $IPC"
for i in $(seq 1 60); do
  if [ -S "$IPC" ]; then
    echo "IPC is ready."
    break
  fi
  sleep 1
done

if [ ! -S "$IPC" ]; then
  echo "[WARN] IPC still not found. You can run later:"
  echo "  cd /root && ./mining-setup.sh"
else
  # Run now (interactive)
  ./mining-setup.sh
fi
# ==================================================
# Step 13: CypherNode-chat (Python + Ollama)
# ==================================================
echo "ðŸ§© Step 13: Setup CypherNode-chat (Python + Ollama)"
cd "$GOPATH/src/github.com/cypherium/cypher"
[ -d CypherNode-chat/.git ] || git clone https://github.com/CypherTroopers/CypherNode-chat.git
cd CypherNode-chat

python3 -m venv .venv
. .venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

curl -fsSL https://ollama.com/install.sh | sh
systemctl enable --now ollama
ollama pull qwen2.5:3b

pm2 start ./.venv/bin/uvicorn \
  --name CypherNode-chat \
  --cwd "$PWD" \
  --interpreter none \
  -- app:app --host 0.0.0.0 --port 9600
pm2 save

echo "DONE"
EOF

chmod +x setup_cypherium.sh
./setup_cypherium.sh
